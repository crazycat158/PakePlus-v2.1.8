<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>拼好本5.1 · 合并标签明细+大字体预览</title>
    <!-- mammoth.js 解析 .docx，Sortable 实现拖拽 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        /* 基础重置 */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            background: linear-gradient(145deg, #d9e6f2 0%, #c0d4e8 100%);
            font-family: 'Segoe UI', Roboto, system-ui, -apple-system, sans-serif;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .app-container {
            max-width: 1600px;
            width: 100%;
            background: #ffffff;
            border-radius: 18px;
            box-shadow: 0 20px 40px rgba(27, 50, 70, 0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 94vh;
            border: 1px solid rgba(255,255,255,0.8);
        }
        /* 顶部工具栏 - 左右分布 */
        .header-area {
            padding: 8px 16px;
            border-bottom: 1px solid #d0e0f0;
            background: #f8fafd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        /* 左侧产品按钮区 */
        .product-bar-header {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            flex: 1;
        }
        .product-btn {
            background: #f0f7ff;
            border: 1px solid #c1d8f0;
            border-radius: 20px;
            padding: 4px 10px;
            font-size: 12px;
            font-weight: 600;
            color: #1e3e5c;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.1s;
            white-space: nowrap;
        }
        .product-btn.active {
            background: #1e364a;
            color: white;
            border-color: #1e364a;
        }
        .product-btn.active .product-settings {
            color: white;
        }
        .product-settings {
            position: relative;
            font-size: 12px;
            cursor: pointer;
            color: #7f99b8;
            background: none;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        .product-settings:hover {
            background: rgba(0,0,0,0.05);
        }
        .add-product-btn {
            background: #e7f0fa;
            border: 1px dashed #9bb9d9;
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 12px;
            font-weight: 600;
            color: #1e3e5c;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        /* 右侧功能按钮区 */
        .action-buttons {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        .tool-btn {
            background: #ffffff;
            border: 1px solid #b8cee4;
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 12px;
            font-weight: 600;
            color: #1e3e5c;
            cursor: pointer;
            transition: background 0.1s, box-shadow 0.1s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            white-space: nowrap;
        }
        .tool-btn:hover {
            background: #e5f0ff;
            border-color: #7fa3c9;
            box-shadow: 0 4px 8px rgba(58, 96, 136, 0.1);
        }
        .tool-btn.danger {
            background: #fff2f2;
            border-color: #f3bcbc;
            color: #b04545;
        }
        .tool-btn.danger:hover {
            background: #ffe5e5;
        }
        .file-input {
            display: none;
        }
        /* 三栏工作区 */
        .workspace {
            display: flex;
            flex: 1;
            min-height: 0;
            overflow: hidden;
            padding: 16px 16px;
            gap: 16px;
            background: #f2f7fd;
        }
        /* 左侧：内容卡片 */
        .left-panel {
            flex: 1;
            background: #ffffff;
            border-radius: 14px;
            border: 1px solid #e2ecf5;
            padding: 16px 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.02);
        }
        .left-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .left-header h3 {
            font-size: 15px;
            font-weight: 600;
            color: #244b6e;
            border-left: 4px solid #f4a261;
            padding-left: 10px;
        }
        .search-bar {
            display: flex;
            align-items: center;
            gap: 4px;
            background: #f5faff;
            border: 1px solid #cbddf2;
            border-radius: 20px;
            padding: 2px 2px 2px 12px;
            flex: 1;
            max-width: 260px;
        }
        .search-bar input {
            border: none;
            background: transparent;
            padding: 5px 0;
            font-size: 13px;
            width: 100%;
            outline: none;
            color: #1f405a;
        }
        .search-bar input::placeholder {
            color: #99b5d3;
        }
        .clear-search {
            background: #e3eefb;
            border: none;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            font-size: 16px;
            cursor: pointer;
            color: #3d6b97;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .clear-search:hover {
            background: #d0e2f7;
        }
        .tags-container {
            display: flex;
            flex-direction: column;
            gap: 14px;
            overflow-y: auto;
            padding-right: 4px;
        }
        .tag-card-full {
            background: #fafdff;
            border: 1px solid #deecf9;
            border-radius: 14px;
            padding: 14px 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
            scroll-margin-top: 20px;
        }
        .tag-title-full {
            font-weight: 700;
            font-size: 16px;
            color: #1e3f5c;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }
        .tag-title-full span.count {
            background: #e7f0fa;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
            color: #2b4a6b;
        }
        .collapse-icon {
            font-size: 15px;
            color: #f4a261;
            margin-left: auto;
            background: #fef3e9;
            width: 26px;
            height: 26px;
            border-radius: 13px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        /* 文案网格两列 */
        .script-items-full {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            margin-top: 4px;
        }
        .script-item-full {
            background: #f5f9ff;
            border-radius: 12px;
            padding: 6px 10px;
            font-size: 12px;
            color: #1c2e40;
            border: 1px solid #d9e2ec;
            word-break: break-word;
            line-height: 1.4;
        }
        .script-item-full::before {
            content: "•";
            color: #e76f51;
            margin-right: 4px;
            font-weight: bold;
        }
        .highlight {
            background-color: #ffe48f;
            color: #1c2e40;
            font-weight: 500;
            padding: 0 2px;
            border-radius: 4px;
        }

        /* 中间：标签目录 (细条) */
        .dir-panel {
            width: 210px;
            background: #ffffff;
            border-radius: 14px;
            border: 1px solid #e2ecf5;
            padding: 16px 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.02);
        }
        .dir-header {
            font-size: 13px;
            font-weight: 600;
            color: #244b6e;
            border-left: 4px solid #f4a261;
            padding-left: 8px;
            margin-bottom: 12px;
        }
        .dir-search {
            display: flex;
            align-items: center;
            gap: 4px;
            background: #f5faff;
            border: 1px solid #cbddf2;
            border-radius: 20px;
            padding: 2px 2px 2px 12px;
            margin-bottom: 14px;
        }
        .dir-search input {
            border: none;
            background: transparent;
            padding: 5px 0;
            font-size: 12px;
            width: 100%;
            outline: none;
            color: #1f405a;
        }
        .dir-search input::placeholder {
            color: #99b5d3;
        }
        .clear-dir-search {
            background: #e3eefb;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            color: #3d6b97;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .clear-dir-search:hover {
            background: #d0e2f7;
        }
        .dir-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .dir-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f9fcff;
            border: 1px solid #deecf9;
            border-radius: 20px;
            padding: 4px 8px 4px 12px;
            font-size: 12px;
            transition: background 0.1s;
        }
        .dir-item:hover {
            background: #e5f0ff;
            border-color: #b8d2f0;
        }
        .dir-tag-name {
            font-weight: 500;
            color: #1e3f5c;
            cursor: pointer;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 2px 0;
        }
        .dir-tag-name:hover {
            color: #f4a261;
        }
        .dir-count {
            background: #dbeafe;
            border-radius: 20px;
            padding: 0 6px;
            font-size: 9px;
            color: #1f4a6e;
            line-height: 1.6;
            font-weight: 600;
            margin-right: 4px;
            white-space: nowrap;
        }
        .dir-add-btn {
            background: #f4a261;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.1s;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .dir-add-btn:hover:not(:disabled) {
            background: #e76f51;
        }
        .dir-add-btn:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            opacity: 0.5;
            box-shadow: none;
        }

        /* 右侧操作台 */
        .right-panel {
            width: 280px;  /* 稍微加宽以适应合并标签的换行 */
            background: #ffffff;
            border-radius: 14px;
            border: 1px solid #e2ecf5;
            display: flex;
            flex-direction: column;
            padding: 16px 12px;
            overflow-y: auto;
            gap: 14px;
            box-shadow: 0 6px 14px rgba(0,0,0,0.02);
        }
        .panel-section {
            background: #f9fcff;
            border-radius: 12px;
            padding: 14px 10px;
            border: 1px solid #e2eefb;
        }
        .panel-section h4 {
            font-size: 13px;
            font-weight: 600;
            color: #244b6e;
            margin-bottom: 10px;
            padding-left: 6px;
            border-left: 3px solid #f4a261;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .order-area {
            background: #f5faff;
            border-radius: 12px;
            border: 2px dashed #aac2df;
            padding: 10px;
            min-height: 140px;
        }
        .order-list {
            display: flex;
            flex-direction: column;
            gap: 8px;  /* 增加间距以适应换行 */
            min-height: 100px;
        }
        .order-tag-item {
            background: #ffffff;
            border: 1px solid #f4cba1;
            border-radius: 20px;
            padding: 6px 8px 6px 10px;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: grab;
            box-shadow: 0 2px 5px rgba(244, 162, 97, 0.1);
        }
        .order-tag-item.merged {
            background: #f0f0ff;
            border-color: #a0a0e0;
            flex-wrap: wrap;  /* 允许换行 */
        }
        .order-tag-item.merge-pending {
            border: 2px solid #4CAF50;
            background: #e8f5e9;
        }
        .order-tag-item .drag-handle {
            color: #e78b4b;
            font-size: 14px;
            cursor: grab;
            align-self: flex-start;
            margin-top: 4px;
        }
        .order-tag-item .tag-name {
            font-weight: 600;
            color: #2d4d6e;
            flex: 1;
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .order-tag-item.merged .tag-name {
            white-space: normal;  /* 合并标签允许换行 */
            word-break: break-word;
            line-height: 1.4;
        }
        .order-tag-item.merged .tag-name .merged-list {
            display: block;
            font-size: 11px;
            color: #4a4a8a;
            margin-top: 2px;
            font-weight: normal;
        }
        .order-merge-btn {
            background: none;
            border: none;
            color: #4CAF50;
            font-size: 16px;
            cursor: pointer;
            padding: 0 2px;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.1s;
            flex-shrink: 0;
        }
        .order-merge-btn:hover {
            background: #e0f2e0;
        }
        .order-remove-btn {
            background: none;
            border: none;
            color: #b04545;
            font-size: 14px;
            cursor: pointer;
            padding: 0 2px;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.1s;
            flex-shrink: 0;
        }
        .order-remove-btn:hover {
            background: #fee5e5;
        }
        .clear-order {
            background: #ffffff;
            border: 1px solid #c5d8f0;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 11px;
            color: #3f6385;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            font-weight: 500;
        }
        .clear-order:hover {
            background: #fcf2e7;
            border-color: #f4a261;
        }
        .setting-item {
            margin-bottom: 12px;
        }
        .setting-item label {
            font-size: 12px;
            font-weight: 600;
            color: #2a4b6e;
            display: block;
            margin-bottom: 4px;
        }
        .number-input {
            width: 100%;
            padding: 5px 8px;
            border: 1px solid #c0d6ee;
            border-radius: 20px;
            font-size: 12px;
            text-align: center;
            background: #ffffff;
        }
        .btn-group {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
        }
        .btn-group .gen-btn {
            flex: 1;
            margin-bottom: 0;
            padding: 6px 0;
            font-size: 13px;
        }

        /* 生成脚本按钮 - 深色 */
        .gen-btn {
            background: #1e364a;
            border: 1px solid #1e364a;
            color: white;
            border-radius: 20px;
            padding: 6px 0;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.1s;
            box-shadow: 0 2px 6px rgba(30, 54, 74, 0.2);
            width: 100%;
        }
        .gen-btn:hover {
            background: #2d506e;
            border-color: #2d506e;
        }

        /* 查看脚本按钮 - 浅色 */
        .view-btn {
            background: #f0f7ff;
            border: 1px solid #b8cee4;
            color: #1e3e5c;
            border-radius: 20px;
            padding: 6px 0;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.1s;
            box-shadow: 0 2px 6px rgba(30, 54, 74, 0.1);
            width: 100%;
        }
        .view-btn:hover {
            background: #e5f0ff;
        }

        .empty-placeholder {
            color: #a2bbd5;
            text-align: center;
            padding: 14px;
            font-style: italic;
            font-size: 12px;
        }

        /* 自定义提示 (toast + 确认框 + 输入框) 白色背景统一风格 */
        .toast-message {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: #1e364a;
            color: white;
            padding: 10px 24px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 500;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            border: 1px solid #f4cba1;
        }
        .toast-message.show {
            opacity: 1;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 25, 40, 0.4);
            backdrop-filter: blur(3px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        .dialog-box {
            background: white;
            border-radius: 18px;
            padding: 24px 28px;
            max-width: 380px;
            width: 90%;
            box-shadow: 0 30px 50px rgba(0, 0, 0, 0.2);
            border: 1px solid #f4dbb1;
        }
        .dialog-message {
            font-size: 15px;
            color: #1e364a;
            margin-bottom: 18px;
            font-weight: 500;
        }
        .dialog-input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #c0d6ee;
            border-radius: 20px;
            font-size: 13px;
            margin-bottom: 20px;
            outline: none;
            background: #f9fcff;
        }
        .dialog-input:focus {
            border-color: #f4a261;
        }
        .dialog-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .dialog-btn {
            padding: 7px 22px;
            border-radius: 20px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .dialog-btn.ok {
            background: #1e364a;
            color: white;
        }
        .dialog-btn.ok:hover {
            background: #2d506e;
        }
        .dialog-btn.cancel {
            background: #f0f6fd;
            color: #1e3b55;
            border-color: #c6d6e9;
        }
        .dialog-btn.cancel:hover {
            background: #e1ecf9;
        }

        /* 设置菜单 - 白色背景，无图标，纯文字 */
        .settings-menu {
            position: absolute;
            background: white;
            border: 1px solid #d9e6f2;
            border-radius: 14px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 150px;
            overflow: hidden;
            padding: 5px 0;
        }
        .settings-menu-item {
            padding: 8px 16px;
            font-size: 12px;
            color: #1e3e5c;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.1s;
            font-weight: 500;
        }
        .settings-menu-item:hover {
            background: #f0f7ff;
        }
        .settings-menu-item.danger:hover {
            background: #fee5e5;
            color: #b04545;
        }

        /* 脚本预览窗口 - 增大字体 */
        .preview-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20000;
        }
        .preview-box {
            background: white;
            border-radius: 18px;
            padding: 20px 24px;
            width: 85%;
            max-width: 1000px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 40px 70px rgba(0, 0, 0, 0.3);
            border: 1px solid #f4dbb1;
        }
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .preview-header h3 {
            font-size: 18px;
            color: #1e364a;
            font-weight: 600;
        }
        .preview-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f99b8;
        }
        .preview-close:hover {
            color: #b04545;
        }
        .preview-textarea {
            flex: 1;
            width: 100%;
            padding: 16px;
            border: 1px solid #c0d6ee;
            border-radius: 14px;
            font-size: 16px;  /* 从13px增大到16px */
            line-height: 1.6;
            font-family: monospace;
            resize: vertical;
            min-height: 300px;
            outline: none;
            background: #f9fcff;
            margin-bottom: 18px;
        }
        .preview-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .preview-btn {
            padding: 10px 26px;  /* 按钮稍微增大 */
            border-radius: 20px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .preview-btn.save {
            background: #1e364a;
            color: white;
        }
        .preview-btn.save:hover {
            background: #2d506e;
        }
        .preview-btn.export {
            background: #f0f7ff;
            color: #1e3e5c;
            border-color: #c6d6e9;
        }
        .preview-btn.export:hover {
            background: #e1ecf9;
        }
        .preview-btn.cancel {
            background: #f0f6fd;
            color: #1e3b55;
            border-color: #c6d6e9;
        }
        .preview-btn.cancel:hover {
            background: #e1ecf9;
        }
    </style>
</head>
<body>
<div class="app-container">
    <!-- 顶部工具栏：左侧产品按钮，右侧功能按钮 -->
    <div class="header-area">
        <div class="product-bar-header" id="productBarHeader"></div>
        <div class="action-buttons">
            <button class="tool-btn" id="exportDataBtn">◀ 导出数据</button>
            <button class="tool-btn" id="importDataBtn">▶ 导入数据</button>
            <button class="tool-btn danger" id="clearAllDbBtn">! 清空所有数据</button>
            <input type="file" id="fileInput" accept=".docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document" class="file-input">
            <input type="file" id="importFileInput" accept=".json,application/json" class="file-input">
        </div>
    </div>

    <!-- 三栏工作区 -->
    <div class="workspace">
        <div class="left-panel">
            <div class="left-header">
                <h3>● 标签内容卡片</h3>
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="搜索关键词..." autocomplete="off">
                    <button class="clear-search" id="clearSearchBtn" title="清除搜索">✖</button>
                </div>
            </div>
            <div id="tagsContainer" class="tags-container">
                <div class="empty-placeholder">请先选择产品并上传文档</div>
            </div>
        </div>

        <div class="dir-panel">
            <div class="dir-header">● 标签目录</div>
            <div class="dir-search">
                <input type="text" id="dirSearchInput" placeholder="过滤标签..." autocomplete="off">
                <button class="clear-dir-search" id="clearDirSearchBtn" title="清除">✖</button>
            </div>
            <div id="dirList" class="dir-list">
                <div class="empty-placeholder">暂无标签</div>
            </div>
        </div>

        <div class="right-panel">
            <div class="panel-section">
                <h4>○ 已选顺序（拖拽调整，点击⊕合并）</h4>
                <div class="order-area">
                    <div id="orderList" class="order-list"></div>
                </div>
                <button id="clearOrderBtn" class="clear-order">✖ 清空已选</button>
            </div>
            <div class="panel-section">
                <h4>⚙ 生成设置</h4>
                <div class="setting-item">
                    <label>生成脚本数量</label>
                    <input type="number" id="scriptCount" class="number-input" min="1" value="1" step="1">
                </div>
                <div class="btn-group">
                    <button id="generateBtn" class="gen-btn">生成脚本</button>
                </div>
                <button id="viewScriptsBtn" class="view-btn">查看脚本</button>
                <div style="font-size: 11px; color: #3f6185; margin-top: 10px; background: #ecf5fc; border-radius: 20px; padding: 8px 12px;">
                    * 按顺序从每个标签随机抽取一条文案，生成不重复的脚本。<br>
                    * 合并后的标签将合并其所有内容去重后随机抽取。<br>
                    * 数据自动保存，下次打开仍存在。
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 自定义弹窗容器（用于动态显示） -->
<div id="toastMessage" class="toast-message"></div>
<div id="dialogOverlay" class="overlay" style="display: none;">
    <div class="dialog-box">
        <div id="dialogMessage" class="dialog-message"></div>
        <input type="text" id="dialogInput" class="dialog-input" placeholder="请输入名称" autocomplete="off">
        <div class="dialog-buttons">
            <button id="dialogOk" class="dialog-btn ok">确定</button>
            <button id="dialogCancel" class="dialog-btn cancel">取消</button>
        </div>
    </div>
</div>

<!-- 脚本预览窗口 -->
<div id="previewOverlay" class="preview-overlay" style="display: none;">
    <div class="preview-box">
        <div class="preview-header">
            <h3 id="previewTitle">脚本预览</h3>
            <button class="preview-close" id="previewCloseBtn">✖</button>
        </div>
        <textarea id="previewTextarea" class="preview-textarea" placeholder="脚本内容，每行一条..."></textarea>
        <div class="preview-buttons">
            <button id="previewSaveBtn" class="preview-btn save">保存</button>
            <button id="previewExportBtn" class="preview-btn export">导出Word</button>
            <button id="previewCancelBtn" class="preview-btn cancel">取消</button>
        </div>
    </div>
</div>

<script>
(function() {
    // ==================== 工具函数 ====================
    const toastEl = document.getElementById('toastMessage');
    const dialogOverlay = document.getElementById('dialogOverlay');
    const dialogMessage = document.getElementById('dialogMessage');
    const dialogInput = document.getElementById('dialogInput');
    const dialogOk = document.getElementById('dialogOk');
    const dialogCancel = document.getElementById('dialogCancel');

    const previewOverlay = document.getElementById('previewOverlay');
    const previewTextarea = document.getElementById('previewTextarea');
    const previewTitle = document.getElementById('previewTitle');
    const previewCloseBtn = document.getElementById('previewCloseBtn');
    const previewSaveBtn = document.getElementById('previewSaveBtn');
    const previewExportBtn = document.getElementById('previewExportBtn');
    const previewCancelBtn = document.getElementById('previewCancelBtn');

    let toastTimeout = null;
    let promptCallback = null;
    let previewCallback = null; // 预览窗口保存时的回调

    function showToast(text, duration = 3000) {
        if (!toastEl) return;
        toastEl.textContent = text;
        toastEl.classList.add('show');
        if (toastTimeout) clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => {
            toastEl.classList.remove('show');
        }, duration);
    }

    function showConfirm(message, onOk, onCancel) {
        dialogInput.style.display = 'none';
        dialogMessage.textContent = message;
        dialogOverlay.style.display = 'flex';
        promptCallback = { type: 'confirm', onOk, onCancel };
    }

    function showPrompt(message, defaultValue, onOk, onCancel) {
        dialogInput.style.display = 'block';
        dialogInput.value = defaultValue || '';
        dialogMessage.textContent = message;
        dialogOverlay.style.display = 'flex';
        promptCallback = { type: 'prompt', onOk, onCancel };
        setTimeout(() => dialogInput.focus(), 100);
    }

    dialogOk.onclick = () => {
        if (!promptCallback) return;
        if (promptCallback.type === 'confirm') {
            promptCallback.onOk?.();
        } else {
            promptCallback.onOk?.(dialogInput.value);
        }
        dialogOverlay.style.display = 'none';
        promptCallback = null;
    };

    dialogCancel.onclick = () => {
        promptCallback?.onCancel?.();
        dialogOverlay.style.display = 'none';
        promptCallback = null;
    };

    dialogOverlay.addEventListener('click', (e) => {
        if (e.target === dialogOverlay) {
            dialogCancel.onclick();
        }
    });

    // 预览窗口关闭
    function closePreview() {
        previewOverlay.style.display = 'none';
        previewCallback = null;
    }

    previewCloseBtn.onclick = closePreview;
    previewCancelBtn.onclick = closePreview;

    // 预览窗口保存
    previewSaveBtn.onclick = () => {
        if (previewCallback) {
            const content = previewTextarea.value;
            previewCallback(content);
        }
        closePreview();
    };

    // 预览窗口导出
    previewExportBtn.onclick = () => {
        const content = previewTextarea.value;
        if (!content.trim()) {
            showToast('没有内容可导出');
            return;
        }
        const blob = new Blob([content], { type: 'application/msword' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `脚本_${new Date().toISOString().slice(0,10)}.doc`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    // 打开预览窗口
    function openPreview(title, initialContent, onSave) {
        previewTitle.textContent = title;
        previewTextarea.value = initialContent;
        previewCallback = onSave;
        previewOverlay.style.display = 'flex';
    }

    // 防抖函数
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // HTML转义
    function escapeHtml(unsafe) {
        return unsafe.replace(/[&<>"]/g, m => {
            if (m === '&') return '&amp;';
            if (m === '<') return '&lt;';
            if (m === '>') return '&gt;';
            if (m === '"') return '&quot;';
            return m;
        });
    }

    // 高亮关键词
    function highlightText(text, keyword) {
        if (!keyword) return escapeHtml(text);
        const escapedKeyword = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`(${escapedKeyword})`, 'gi');
        const parts = text.split(regex);
        let result = '';
        for (let i = 0; i < parts.length; i++) {
            const part = parts[i];
            if (i % 2 === 0) result += escapeHtml(part);
            else result += `<span class="highlight">${escapeHtml(part)}</span>`;
        }
        return result;
    }

    // 获取标签前缀
    function getTagPrefix(tag) {
        const hyphenIndex = tag.indexOf('-');
        return hyphenIndex === -1 ? tag : tag.substring(0, hyphenIndex);
    }

    // ==================== 数据状态 ====================
    let products = [];
    let currentProduct = null;
    const productData = new Map(); // product -> { labels, allTags, collapsed, orderList, savedScripts, mergedTags }

    let currentLabels = {};
    let currentAllTags = [];
    let currentCollapsed = {};
    let currentOrderTags = [];
    let currentSavedScripts = []; // 当前产品保存的脚本数组
    let currentMergedTags = {};   // 当前产品的合并映射 { mergedName: [tag1, tag2] }

    let searchKeyword = '';
    let dirSearchKeyword = '';

    // 合并状态
    let mergePendingTag = null; // 等待合并的标签名

    // DOM 元素
    const productBarHeader = document.getElementById('productBarHeader');
    const tagsContainer = document.getElementById('tagsContainer');
    const dirListEl = document.getElementById('dirList');
    const orderListEl = document.getElementById('orderList');
    const clearOrderBtn = document.getElementById('clearOrderBtn');
    const scriptCountInput = document.getElementById('scriptCount');
    const generateBtn = document.getElementById('generateBtn');
    const viewScriptsBtn = document.getElementById('viewScriptsBtn');
    const exportDataBtn = document.getElementById('exportDataBtn');
    const importDataBtn = document.getElementById('importDataBtn');
    const clearAllDbBtn = document.getElementById('clearAllDbBtn');
    const fileInput = document.getElementById('fileInput');
    const importFileInput = document.getElementById('importFileInput');
    const searchInput = document.getElementById('searchInput');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    const dirSearchInput = document.getElementById('dirSearchInput');
    const clearDirSearchBtn = document.getElementById('clearDirSearchBtn');

    let orderSortable;

    // ==================== IndexedDB 封装 ====================
    const DB_NAME = 'ScriptMergerDB';
    const DB_VERSION = 4; // 升级版本以支持 mergedTags
    const STORE_NAME = 'scripts';

    function openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (db.objectStoreNames.contains(STORE_NAME)) {
                    db.deleteObjectStore(STORE_NAME);
                }
                const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                store.createIndex('product', 'product', { unique: false });
                store.createIndex('tag', 'tag', { unique: false });
                store.createIndex('product_tag', ['product', 'tag'], { unique: false });
            };
        });
    }

    // 读取所有数据
    async function loadAllFromDB() {
        const db = await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.getAll();
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                const entries = request.result;
                const productMap = new Map();
                entries.forEach(entry => {
                    const { product, tag, content } = entry;
                    if (!productMap.has(product)) {
                        productMap.set(product, {});
                    }
                    const productLabels = productMap.get(product);
                    if (!productLabels[tag]) productLabels[tag] = [];
                    productLabels[tag].push(content);
                });
                resolve(productMap);
            };
        });
    }

    // 批量保存
    async function saveEntries(entries) {
        const db = await openDB();
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        for (let { product, tag, content } of entries) {
            store.add({ product, tag, content });
        }
        return new Promise((resolve, reject) => {
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
        });
    }

    // 删除某个产品的所有数据
    async function deleteProductData(product) {
        const db = await openDB();
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        const index = store.index('product');
        const request = index.openCursor(IDBKeyRange.only(product));
        return new Promise((resolve, reject) => {
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    store.delete(cursor.primaryKey);
                    cursor.continue();
                } else {
                    if (tx.error) reject(tx.error);
                    else resolve();
                }
            };
            request.onerror = () => reject(request.error);
        });
    }

    // 清空所有数据
    async function clearAllDB() {
        const db = await openDB();
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        store.clear();
        return new Promise((resolve, reject) => {
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
        });
    }

    // 从数据库刷新内存数据 (不包含 savedScripts 和 mergedTags, 需要从 localStorage 额外加载)
    async function refreshFromDB() {
        const productMap = await loadAllFromDB();
        productData.clear();
        products = [];
        for (let [product, labelsObj] of productMap.entries()) {
            products.push(product);
            const tags = Object.keys(labelsObj);
            // 分组排序
            const groups = {};
            tags.forEach(tag => {
                const prefix = getTagPrefix(tag);
                if (!groups[prefix]) groups[prefix] = [];
                groups[prefix].push(tag);
            });
            Object.keys(groups).forEach(prefix => {
                groups[prefix].sort((a, b) => labelsObj[b].length - labelsObj[a].length);
            });
            const sortedPrefixes = Object.keys(groups).sort((a, b) => a.localeCompare(b));
            const allTags = [];
            sortedPrefixes.forEach(prefix => {
                allTags.push(...groups[prefix]);
            });

            // 从 localStorage 加载 savedScripts
            let savedScripts = [];
            try {
                const saved = localStorage.getItem(`savedScripts_${product}`);
                if (saved) {
                    savedScripts = JSON.parse(saved);
                }
            } catch (e) {
                console.warn('加载保存脚本失败', e);
            }

            // 从 localStorage 加载 mergedTags
            let mergedTags = {};
            try {
                const merged = localStorage.getItem(`mergedTags_${product}`);
                if (merged) {
                    mergedTags = JSON.parse(merged);
                }
            } catch (e) {
                console.warn('加载合并标签失败', e);
            }

            productData.set(product, {
                labels: labelsObj,
                allTags: allTags,
                collapsed: {},
                orderList: [],
                savedScripts: savedScripts,
                mergedTags: mergedTags
            });
        }
        // 处理当前产品
        if (currentProduct && !products.includes(currentProduct)) {
            currentProduct = products.length > 0 ? products[0] : null;
        } else if (!currentProduct && products.length > 0) {
            currentProduct = products[0];
        }
        updateCurrentProductData();
        renderProductBar();
        if (currentProduct) {
            renderLeft();
            renderDirectory();
            renderOrderListFromData();
        } else {
            tagsContainer.innerHTML = `<div class="empty-placeholder">请先创建产品，然后上传文档</div>`;
            dirListEl.innerHTML = `<div class="empty-placeholder">暂无标签</div>`;
            orderListEl.innerHTML = `<div class="empty-placeholder">将标签拖拽至此</div>`;
        }
    }

    // 更新当前产品引用
    function updateCurrentProductData() {
        if (!currentProduct || !productData.has(currentProduct)) {
            currentLabels = {};
            currentAllTags = [];
            currentCollapsed = {};
            currentOrderTags = [];
            currentSavedScripts = [];
            currentMergedTags = {};
            return;
        }
        const data = productData.get(currentProduct);
        currentLabels = data.labels;
        currentAllTags = data.allTags;
        currentCollapsed = data.collapsed;
        currentOrderTags = data.orderList;
        currentSavedScripts = data.savedScripts;
        currentMergedTags = data.mergedTags || {};
    }

    // 保存当前顺序到数据
    function saveCurrentOrderToData() {
        if (!currentProduct) return;
        const data = productData.get(currentProduct);
        if (data) {
            data.orderList = [...currentOrderTags];
        }
    }

    // 保存当前产品的脚本到 localStorage
    function saveScriptsToStorage() {
        if (!currentProduct) return;
        try {
            localStorage.setItem(`savedScripts_${currentProduct}`, JSON.stringify(currentSavedScripts));
        } catch (e) {
            console.warn('保存脚本到localStorage失败', e);
        }
    }

    // 保存合并映射到 localStorage
    function saveMergedTagsToStorage() {
        if (!currentProduct) return;
        try {
            localStorage.setItem(`mergedTags_${currentProduct}`, JSON.stringify(currentMergedTags));
        } catch (e) {
            console.warn('保存合并标签失败', e);
        }
    }

    // 渲染顺序区（带合并标签明细）
    function renderOrderListFromData() {
        orderListEl.innerHTML = '';
        if (currentOrderTags.length === 0) {
            orderListEl.innerHTML = `<div class="empty-placeholder">将标签拖拽至此</div>`;
        } else {
            currentOrderTags.forEach(tag => {
                const isMerged = currentMergedTags.hasOwnProperty(tag);
                const orderItem = document.createElement('div');
                orderItem.className = 'order-tag-item' + (isMerged ? ' merged' : '');
                if (tag === mergePendingTag) {
                    orderItem.classList.add('merge-pending');
                }
                orderItem.dataset.label = tag;

                let displayName = '';
                if (isMerged) {
                    const tags = currentMergedTags[tag];
                    // 生成合并标签显示内容：合并名称 + 换行 + 包含的标签列表
                    const tagsList = tags.map(t => `#${escapeHtml(t)}#`).join(' ');
                    displayName = `<span class="tag-name">#${escapeHtml(tag)}#<span class="merged-list">包含: ${tagsList}</span></span>`;
                } else {
                    displayName = `<span class="tag-name">#${escapeHtml(tag)}#</span>`;
                }

                orderItem.innerHTML = `
                    <span class="drag-handle">☰</span>
                    ${displayName}
                    <button class="order-merge-btn" title="合并">⊕</button>
                    <button class="order-remove-btn" title="移除">✖</button>
                `;
                orderListEl.appendChild(orderItem);
            });
            // 绑定按钮事件
            document.querySelectorAll('.order-remove-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const item = btn.closest('.order-tag-item');
                    const tag = item.dataset.label;
                    removeFromOrder(tag);
                });
            });
            document.querySelectorAll('.order-merge-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const item = btn.closest('.order-tag-item');
                    const tag = item.dataset.label;
                    handleMergeClick(tag);
                });
            });
        }
        initOrderSortable();
        // 清除等待合并状态（如果已取消）
        if (mergePendingTag && !currentOrderTags.includes(mergePendingTag)) {
            mergePendingTag = null;
        }
    }

    // 合并按钮点击处理
    function handleMergeClick(tag) {
        if (mergePendingTag === null) {
            // 第一次点击：进入等待合并状态
            mergePendingTag = tag;
            renderOrderListFromData(); // 重新渲染以高亮
        } else if (mergePendingTag === tag) {
            // 点击同一个标签：取消合并
            mergePendingTag = null;
            renderOrderListFromData();
        } else {
            // 点击另一个标签：执行合并
            const tagA = mergePendingTag;
            const tagB = tag;
            // 确保两个标签都存在且不是同一个
            if (!currentOrderTags.includes(tagA) || !currentOrderTags.includes(tagB)) {
                showToast('标签不存在');
                mergePendingTag = null;
                renderOrderListFromData();
                return;
            }
            // 生成合并标签名（按字母顺序排序以确保一致性）
            const sorted = [tagA, tagB].sort();
            const mergedName = sorted[0] + '+' + sorted[1];
            
            // 检查是否已经存在该合并标签
            if (currentMergedTags[mergedName]) {
                // 如果已存在，直接使用
                // 从顺序区移除 tagA 和 tagB
                currentOrderTags = currentOrderTags.filter(t => t !== tagA && t !== tagB);
                // 如果合并标签不在顺序区，添加
                if (!currentOrderTags.includes(mergedName)) {
                    currentOrderTags.push(mergedName);
                }
            } else {
                // 创建新的合并标签
                const sourceTags = [tagA, tagB];
                currentMergedTags[mergedName] = sourceTags;
                // 从顺序区移除 tagA 和 tagB
                currentOrderTags = currentOrderTags.filter(t => t !== tagA && t !== tagB);
                currentOrderTags.push(mergedName);
                // 保存合并映射
                saveMergedTagsToStorage();
            }
            
            // 清除等待状态
            mergePendingTag = null;
            // 更新数据并重新渲染
            saveCurrentOrderToData();
            renderOrderListFromData();
            renderDirectory(); // 更新目录（目录中不会显示合并标签，但可能需要刷新）
            showToast(`已合并为“${mergedName}”`);
        }
    }

    function removeFromOrder(tag) {
        const index = currentOrderTags.indexOf(tag);
        if (index !== -1) {
            currentOrderTags.splice(index, 1);
            // 如果移除的是合并标签，可以选择保留合并映射（暂时不清除，避免数据丢失）
            // 如果需要彻底清理，可以判断如果合并标签不在任何地方使用，则删除
            // 为了简单，暂不清除映射
            saveCurrentOrderToData();
            renderOrderListFromData();
            renderDirectory();
        }
    }

    function addTagToOrder(tag) {
        if (!currentProduct) {
            showToast('请先选择或创建一个产品');
            return;
        }
        if (currentOrderTags.includes(tag)) {
            showToast('标签已在顺序区中');
            return;
        }
        currentOrderTags.push(tag);
        saveCurrentOrderToData();
        renderOrderListFromData();
        renderDirectory();
    }

    function clearOrder() {
        if (!currentProduct) return;
        currentOrderTags = [];
        saveCurrentOrderToData();
        renderOrderListFromData();
        renderDirectory();
    }

    // ==================== 渲染函数 ====================
    function renderProductBar() {
        let html = '';
        products.forEach(product => {
            const activeClass = (product === currentProduct) ? 'active' : '';
            html += `
                <div class="product-btn ${activeClass}" data-product="${escapeHtml(product)}">
                    <span class="product-name">${escapeHtml(product)}</span>
                    <span class="product-settings" data-product="${escapeHtml(product)}">⚙</span>
                </div>
            `;
        });
        html += `<button class="add-product-btn" id="addProductBtn">+ 新建产品</button>`;
        productBarHeader.innerHTML = html;

        document.querySelectorAll('.product-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                if (e.target.classList.contains('product-settings')) return;
                const product = btn.dataset.product;
                switchProduct(product);
            });
        });
        document.querySelectorAll('.product-settings').forEach(icon => {
            icon.addEventListener('click', (e) => {
                e.stopPropagation();
                const product = icon.dataset.product;
                showSettingsMenu(icon, product);
            });
        });
        document.getElementById('addProductBtn').addEventListener('click', () => {
            showPrompt('请输入新产品名称', '', (name) => {
                if (name && name.trim()) {
                    createProduct(name.trim());
                }
            });
        });
    }

    function switchProduct(product) {
        if (product === currentProduct) return;
        saveCurrentOrderToData();
        currentProduct = product;
        updateCurrentProductData();
        searchKeyword = '';
        searchInput.value = '';
        dirSearchKeyword = '';
        dirSearchInput.value = '';
        mergePendingTag = null; // 清空合并等待状态
        renderProductBar();
        renderLeft();
        renderDirectory();
        renderOrderListFromData();
    }

    async function createProduct(name) {
        if (products.includes(name)) {
            showToast('产品已存在');
            return;
        }
        products.push(name);
        productData.set(name, {
            labels: {},
            allTags: [],
            collapsed: {},
            orderList: [],
            savedScripts: [],
            mergedTags: {}
        });
        switchProduct(name);
    }

    async function deleteProduct(product) {
        if (!products.includes(product)) return;
        showConfirm(`确定要删除产品“${product}”及其所有内容吗？`, async () => {
            await deleteProductData(product);
            // 清除 localStorage 中的脚本和合并映射
            localStorage.removeItem(`savedScripts_${product}`);
            localStorage.removeItem(`mergedTags_${product}`);
            products = products.filter(p => p !== product);
            productData.delete(product);
            if (currentProduct === product) {
                currentProduct = products.length > 0 ? products[0] : null;
                updateCurrentProductData();
            }
            renderProductBar();
            if (currentProduct) {
                renderLeft();
                renderDirectory();
                renderOrderListFromData();
            } else {
                tagsContainer.innerHTML = `<div class="empty-placeholder">请先创建产品，然后上传文档</div>`;
                dirListEl.innerHTML = `<div class="empty-placeholder">暂无标签</div>`;
                orderListEl.innerHTML = `<div class="empty-placeholder">将标签拖拽至此</div>`;
            }
            showToast(`产品“${product}”已删除`);
        });
    }

    async function clearProductData(product) {
        if (!product) return;
        await deleteProductData(product);
        localStorage.removeItem(`savedScripts_${product}`);
        localStorage.removeItem(`mergedTags_${product}`);
        productData.set(product, {
            labels: {},
            allTags: [],
            collapsed: {},
            orderList: [],
            savedScripts: [],
            mergedTags: {}
        });
        if (currentProduct === product) {
            updateCurrentProductData();
            renderLeft();
            renderDirectory();
            renderOrderListFromData();
        }
        showToast(`产品“${product}”数据已清除`);
    }

    // ==================== 优化后的设置菜单 ====================
    function showSettingsMenu(iconElement, product) {
        // 移除已有的菜单
        document.querySelectorAll('.settings-menu').forEach(m => m.remove());

        const menu = document.createElement('div');
        menu.className = 'settings-menu';
        menu.innerHTML = `
            <div class="settings-menu-item" data-action="upload">上传文档（仅此页）</div>
            <div class="settings-menu-item" data-action="clear">清除数据（仅此页）</div>
            <div class="settings-menu-item danger" data-action="delete">删除此按钮</div>
        `;
        document.body.appendChild(menu);

        const rect = iconElement.getBoundingClientRect();
        const menuWidth = menu.offsetWidth;
        const menuHeight = menu.offsetHeight;

        // 计算菜单位置（默认右下弹出）
        let left = rect.left + window.scrollX;
        let top = rect.bottom + window.scrollY + 5;

        // 如果菜单会超出右边界，则向左偏移
        if (left + menuWidth > window.innerWidth + window.scrollX) {
            left = rect.right + window.scrollX - menuWidth;
        }
        // 如果菜单会超出下边界，则向上偏移
        if (top + menuHeight > window.innerHeight + window.scrollY) {
            top = rect.top + window.scrollY - menuHeight - 5;
        }

        menu.style.position = 'absolute';
        menu.style.top = top + 'px';
        menu.style.left = left + 'px';

        menu.addEventListener('click', (e) => {
            const action = e.target.dataset.action;
            if (!action) return;
            e.stopPropagation();
            menu.remove();
            if (action === 'upload') {
                fileInput.click();
                window.__uploadForProduct = product;
            } else if (action === 'clear') {
                clearProductData(product);
            } else if (action === 'delete') {
                deleteProduct(product);
            }
        });

        // 点击其他地方关闭
        setTimeout(() => {
            window.addEventListener('click', function handler(e) {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    window.removeEventListener('click', handler);
                }
            });
        }, 0);
    }

    // 渲染左侧卡片
    function renderLeft() {
        if (!currentProduct || !currentLabels || Object.keys(currentLabels).length === 0) {
            tagsContainer.innerHTML = `<div class="empty-placeholder">请先选择产品并上传文档</div>`;
            return;
        }
        let html = '';
        const kw = searchKeyword.trim().toLowerCase();
        currentAllTags.forEach(tag => {
            const items = currentLabels[tag] || [];
            if (kw && !items.some(text => text.toLowerCase().includes(kw))) return;
            const isCollapsed = currentCollapsed[tag] || false;
            const collapseIcon = isCollapsed ? '▶' : '▼';
            const itemsHtml = items.map(text => `<div class="script-item-full">${highlightText(text, kw)}</div>`).join('');
            html += `
                <div class="tag-card-full" id="card-${escapeHtml(tag)}" data-tag="${escapeHtml(tag)}">
                    <div class="tag-title-full">
                        #${escapeHtml(tag)}#
                        <span class="count">${items.length} 条</span>
                        <span class="collapse-icon">${collapseIcon}</span>
                    </div>
                    <div class="script-items-full" style="display: ${isCollapsed ? 'none' : 'grid'};">
                        ${itemsHtml || '<div style="color:#aaa; padding:8px; grid-column:span 2;">无文案</div>'}
                    </div>
                </div>
            `;
        });
        if (html === '') {
            tagsContainer.innerHTML = `<div class="empty-placeholder">没有包含“${escapeHtml(kw)}”的标签</div>`;
        } else {
            tagsContainer.innerHTML = html;
        }
        document.querySelectorAll('.tag-card-full').forEach(card => {
            const tag = card.dataset.tag;
            const titleDiv = card.querySelector('.tag-title-full');
            titleDiv.addEventListener('click', (e) => {
                e.stopPropagation();
                currentCollapsed[tag] = !currentCollapsed[tag];
                renderLeft();
            });
        });
    }

    function renderDirectory() {
        if (!currentProduct || !currentLabels || Object.keys(currentLabels).length === 0) {
            dirListEl.innerHTML = `<div class="empty-placeholder">暂无标签</div>`;
            return;
        }
        const usedTags = new Set(currentOrderTags);
        const kw = dirSearchKeyword.trim().toLowerCase();
        let filteredTags = currentAllTags;
        if (kw) {
            filteredTags = currentAllTags.filter(tag => tag.toLowerCase().includes(kw));
        }

        if (filteredTags.length === 0) {
            dirListEl.innerHTML = `<div class="empty-placeholder">无匹配标签</div>`;
            return;
        }

        let html = '';
        filteredTags.forEach(tag => {
            const count = currentLabels[tag] ? currentLabels[tag].length : 0;
            const disabled = usedTags.has(tag);
            html += `
                <div class="dir-item" data-tag="${escapeHtml(tag)}">
                    <span class="dir-tag-name" title="${escapeHtml(tag)}">#${escapeHtml(tag)}#</span>
                    <span class="dir-count">${count}</span>
                    <button class="dir-add-btn" ${disabled ? 'disabled' : ''} title="${disabled ? '已添加' : '添加到顺序区'}">+</button>
                </div>
            `;
        });
        dirListEl.innerHTML = html;

        document.querySelectorAll('.dir-tag-name').forEach(el => {
            const tag = el.closest('.dir-item').dataset.tag;
            el.addEventListener('click', () => {
                searchInput.value = '';
                searchKeyword = '';
                if (currentCollapsed[tag]) {
                    currentCollapsed[tag] = false;
                }
                renderLeft();
                setTimeout(() => {
                    document.getElementById(`card-${tag}`)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 50);
            });
        });

        document.querySelectorAll('.dir-add-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const dirItem = btn.closest('.dir-item');
                const tag = dirItem.dataset.tag;
                if (!tag) return;
                addTagToOrder(tag);
            });
        });
    }

    function initOrderSortable() {
        if (orderSortable) orderSortable.destroy();
        orderSortable = new Sortable(orderListEl, {
            animation: 150,
            draggable: '.order-tag-item',
            group: { name: 'order', pull: false, put: false },
            sort: true,
            onEnd: (evt) => {
                const items = Array.from(orderListEl.children).filter(child => child.classList.contains('order-tag-item'));
                currentOrderTags = items.map(item => item.dataset.label);
                saveCurrentOrderToData();
            }
        });
    }

    // ==================== 文档解析与上传 ====================
    function parseWordText(text) {
        const lines = text.split(/\r?\n/);
        const entries = [];
        const tagRegex = /#([^#]+)#$/;
        lines.forEach(line => {
            const trimmed = line.trim();
            if (!trimmed) return;
            const match = trimmed.match(tagRegex);
            if (match) {
                const tag = match[1].trim();
                let content = trimmed.replace(/\s*#[^#]+#$/, '').trim();
                if (content) entries.push({ tag, content });
            }
        });
        return entries;
    }

    async function handleFile(file, product) {
        if (!file) return;
        if (!file.name.toLowerCase().endsWith('.docx')) {
            showToast('请上传 .docx 格式的 Word 文档。');
            return;
        }
        const reader = new FileReader();
        reader.onload = async (e) => {
            let entries = [];
            try {
                const result = await mammoth.extractRawText({ arrayBuffer: e.target.result });
                entries = parseWordText(result.value);
                if (entries.length === 0) {
                    showToast('未识别到任何带标签的段落。请确保每段末尾有 #标签# 格式。');
                    return;
                }
            } catch (err) {
                console.error('文档解析失败:', err);
                showToast('文档解析失败：' + err.message);
                return;
            }

            try {
                const dbEntries = entries.map(e => ({ product, tag: e.tag, content: e.content }));
                await saveEntries(dbEntries);
            } catch (err) {
                console.error('数据保存失败:', err);
                showToast('数据保存失败：' + err.message);
                return;
            }

            try {
                await refreshFromDB();
            } catch (err) {
                console.error('刷新界面失败:', err);
                showToast('数据已保存，但刷新界面失败，请重启应用');
                return;
            }

            showToast(`合并完成，共处理 ${entries.length} 条文案。`);
        };
        reader.readAsArrayBuffer(file);
    }

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        const product = window.__uploadForProduct || currentProduct;
        if (!product) {
            showToast('请先选择产品');
            return;
        }
        if (file) handleFile(file, product);
        fileInput.value = '';
        window.__uploadForProduct = null;
    });

    // ==================== 导入导出 ====================
    async function handleImportFile(file) {
        if (!file) return;
        if (!file.name.toLowerCase().endsWith('.json')) {
            showToast('请上传 .json 格式的数据文件。');
            return;
        }
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const jsonData = JSON.parse(e.target.result);
                if (!jsonData.products || !Array.isArray(jsonData.products)) {
                    showToast('无效的数据格式：缺少 products 数组。');
                    return;
                }
                const entries = [];
                for (const prod of jsonData.products) {
                    const productName = prod.name;
                    if (!productName) continue;
                    if (prod.labels) {
                        for (const tag in prod.labels) {
                            if (Array.isArray(prod.labels[tag])) {
                                prod.labels[tag].forEach(content => {
                                    if (content && typeof content === 'string') {
                                        entries.push({ product: productName, tag, content });
                                    }
                                });
                            }
                        }
                    }
                    // 恢复 savedScripts
                    if (prod.savedScripts) {
                        localStorage.setItem(`savedScripts_${productName}`, JSON.stringify(prod.savedScripts));
                    }
                    // 恢复 mergedTags
                    if (prod.mergedTags) {
                        localStorage.setItem(`mergedTags_${productName}`, JSON.stringify(prod.mergedTags));
                    }
                }
                if (entries.length === 0) {
                    showToast('导入数据中无有效文案。');
                    return;
                }
                await saveEntries(entries);
                await refreshFromDB();
                showToast(`导入完成，共处理 ${entries.length} 条文案。`);
            } catch (err) {
                console.error(err);
                showToast('解析 JSON 文件失败，请确保文件格式正确。');
            }
        };
        reader.readAsText(file);
    }

    importDataBtn.addEventListener('click', () => importFileInput.click());
    importFileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) handleImportFile(file);
        importFileInput.value = '';
    });

    async function exportData() {
        if (products.length === 0) {
            showToast('没有可导出的数据');
            return;
        }
        const exportObj = {
            products: products.map(p => {
                const data = productData.get(p);
                return {
                    name: p,
                    labels: data.labels,
                    orderList: data.orderList,
                    savedScripts: data.savedScripts,
                    mergedTags: data.mergedTags
                };
            }),
            exportTime: new Date().toISOString()
        };
        const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `多产品数据_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    async function handleClearAll() {
        showConfirm('确定要清空所有产品及其数据吗？此操作不可恢复。', async () => {
            await clearAllDB();
            // 清除所有产品的 localStorage
            for (let product of products) {
                localStorage.removeItem(`savedScripts_${product}`);
                localStorage.removeItem(`mergedTags_${product}`);
            }
            products = [];
            productData.clear();
            currentProduct = null;
            currentLabels = {};
            currentAllTags = [];
            currentCollapsed = {};
            currentOrderTags = [];
            currentSavedScripts = [];
            currentMergedTags = {};
            renderProductBar();
            tagsContainer.innerHTML = `<div class="empty-placeholder">请先创建产品，然后上传文档</div>`;
            dirListEl.innerHTML = `<div class="empty-placeholder">暂无标签</div>`;
            orderListEl.innerHTML = `<div class="empty-placeholder">将标签拖拽至此</div>`;
            showToast('所有数据已清空。');
        });
    }

    // ==================== 生成脚本 ====================
    function generateAndExport() {
        if (!currentProduct || currentOrderTags.length === 0) {
            showToast('请先选择产品并在顺序区添加标签');
            return;
        }

        // 检查所有标签（包括合并标签内的原始标签）是否有文案
        for (let tag of currentOrderTags) {
            if (currentMergedTags[tag]) {
                // 合并标签：检查其包含的所有原始标签
                const sourceTags = currentMergedTags[tag];
                for (let srcTag of sourceTags) {
                    if (!currentLabels[srcTag] || currentLabels[srcTag].length === 0) {
                        showToast(`合并标签“${tag}”包含的原始标签“${srcTag}”下没有可用的文案。`);
                        return;
                    }
                }
            } else {
                if (!currentLabels[tag] || currentLabels[tag].length === 0) {
                    showToast(`标签“${tag}”下没有可用的文案。`);
                    return;
                }
            }
        }

        const count = parseInt(scriptCountInput.value, 10);
        if (isNaN(count) || count < 1) {
            showToast('生成数量必须为大于0的整数');
            return;
        }

        const scripts = [];
        const uniqueSet = new Set();
        let attempts = 0;
        const maxAttempts = count * 100;

        while (scripts.length < count && attempts < maxAttempts) {
            attempts++;
            const parts = currentOrderTags.map(tag => {
                if (currentMergedTags[tag]) {
                    // 合并标签：从所有源标签收集文案，去重后随机抽取
                    const sourceTags = currentMergedTags[tag];
                    let allContents = [];
                    sourceTags.forEach(srcTag => {
                        if (currentLabels[srcTag]) {
                            allContents = allContents.concat(currentLabels[srcTag]);
                        }
                    });
                    // 去重
                    const uniqueContents = [...new Set(allContents)];
                    if (uniqueContents.length === 0) return '';
                    return uniqueContents[Math.floor(Math.random() * uniqueContents.length)];
                } else {
                    // 普通标签
                    const arr = currentLabels[tag];
                    return arr[Math.floor(Math.random() * arr.length)];
                }
            });
            const scriptLine = parts.join('');
            if (!uniqueSet.has(scriptLine)) {
                uniqueSet.add(scriptLine);
                scripts.push(scriptLine);
            }
            if (scripts.length >= count) break;
        }

        if (scripts.length === 0) {
            showToast('无法生成任何脚本，请检查标签文案或顺序。');
            return;
        }
        if (scripts.length < count) {
            showToast(`只能生成 ${scripts.length} 条不重复的脚本，已达到组合上限。`);
        }

        // 打开预览窗口，传入新生成的脚本，保存时追加到现有脚本（去重）
        const newScripts = scripts;
        const existingScripts = currentSavedScripts;
        const initialContent = newScripts.join('\n\n');

        openPreview('新生成的脚本', initialContent, (editedContent) => {
            const lines = editedContent.split(/\n+/).map(s => s.trim()).filter(s => s.length > 0);
            const uniqueLines = [...new Set(lines)];
            const merged = [...existingScripts, ...uniqueLines];
            const finalScripts = [...new Set(merged)];
            currentSavedScripts = finalScripts;
            const data = productData.get(currentProduct);
            if (data) data.savedScripts = finalScripts;
            saveScriptsToStorage();
            showToast(`已保存 ${uniqueLines.length} 条新脚本，当前共有 ${finalScripts.length} 条。`);
        });
    }

    // 查看已保存的脚本
    function viewSavedScripts() {
        if (!currentProduct) {
            showToast('请先选择产品');
            return;
        }
        const scripts = currentSavedScripts;
        const content = scripts.join('\n\n');
        openPreview('已保存的脚本', content, (editedContent) => {
            const lines = editedContent.split(/\n+/).map(s => s.trim()).filter(s => s.length > 0);
            const uniqueLines = [...new Set(lines)];
            currentSavedScripts = uniqueLines;
            const data = productData.get(currentProduct);
            if (data) data.savedScripts = uniqueLines;
            saveScriptsToStorage();
            showToast(`已保存 ${uniqueLines.length} 条脚本。`);
        });
    }

    // ==================== 搜索优化（防抖） ====================
    const debouncedRenderLeft = debounce(renderLeft, 250);
    const debouncedRenderDirectory = debounce(renderDirectory, 250);

    function handleSearch() {
        searchKeyword = searchInput.value;
        debouncedRenderLeft();
    }
    function clearSearch() {
        searchInput.value = '';
        searchKeyword = '';
        renderLeft();
    }
    function handleDirSearch() {
        dirSearchKeyword = dirSearchInput.value;
        debouncedRenderDirectory();
    }
    function clearDirSearch() {
        dirSearchInput.value = '';
        dirSearchKeyword = '';
        renderDirectory();
    }

    // ==================== 事件绑定 ====================
    clearOrderBtn.addEventListener('click', clearOrder);
    generateBtn.addEventListener('click', generateAndExport);
    viewScriptsBtn.addEventListener('click', viewSavedScripts);
    exportDataBtn.addEventListener('click', exportData);
    clearAllDbBtn.addEventListener('click', handleClearAll);
    searchInput.addEventListener('input', handleSearch);
    clearSearchBtn.addEventListener('click', clearSearch);
    dirSearchInput.addEventListener('input', handleDirSearch);
    clearDirSearchBtn.addEventListener('click', clearDirSearch);

    // ==================== 初始化 ====================
    (async () => {
        await refreshFromDB();
        renderProductBar();
        if (currentProduct) {
            renderLeft();
            renderDirectory();
            renderOrderListFromData();
        } else {
            orderListEl.innerHTML = `<div class="empty-placeholder">将标签拖拽至此</div>`;
        }
        initOrderSortable();
    })();
})();
</script>
</body>
</html>